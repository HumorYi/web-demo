var bs=angular.module("bs",["ionic"]);bs.service("$get",["$http","$ionicLoading","$bsAlter",function($http,$ionicLoading,$bsAlter){this.sendRequest=function(url,successCallback){$ionicLoading.show({template:"loading..."});$http.get(url).success(function(response){$ionicLoading.hide();if(response.code&&response.code===4){$bsAlter.alert(response.msg);return}successCallback&&successCallback(response)}).error(function(err){console.log(err)})}}]);bs.service("$post",["$http","$ionicLoading","$bsAlter",function($http,$ionicLoading,$bsAlter){this.sendRequest=function(url,data,successCallback){$ionicLoading.show({template:"loading..."});$http({method:"POST",url:url,headers:{"content-type":"application/x-www-form-urlencoded; charset=utf-8"},data:data,transformRequest:function(obj){var str=[];for(var p in obj){str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]))}return str.join("&")}}).success(function(response){$ionicLoading.hide();if(response.code&&response.code===4){$bsAlter.alert(response.msg);return}successCallback&&successCallback(response)}).error(function(err){console.log(err)})}}]);bs.service("$bsAlter",["$ionicPopup",function($ionicPopup){this.alert=function(str){$ionicPopup.alert({template:str})}}]);bs.config(function($stateProvider,$ionicConfigProvider,$urlRouterProvider){$ionicConfigProvider.tabs.position("bottom");$stateProvider.state("start",{url:"/bs_start",templateUrl:"tpl/start.html"}).state("main",{url:"/bs_main",templateUrl:"tpl/main.html",controller:"mainCtrl"}).state("detail",{url:"/bs_detail/:bid",templateUrl:"tpl/detail.html",controller:"detailCtrl"}).state("order",{url:"/bs_order/:bid",params:{cids:null},templateUrl:"tpl/order.html",controller:"orderCtrl"}).state("myOrder",{url:"/bs_myOrder",templateUrl:"tpl/myOrder.html",controller:"myOrderCtrl"}).state("myCart",{url:"/bs_myCart",templateUrl:"tpl/myCart.html",controller:"myCartCtrl"}).state("myHeart",{url:"/bs_myHeart",templateUrl:"tpl/myHeart.html",controller:"myHeartCtrl"}).state("user",{url:"/bs_user",templateUrl:"tpl/user.html",controller:"userCtrl"}).state("userMsg",{url:"/bs_userMsg",templateUrl:"tpl/userMsg.html",controller:"userMsgCtrl"}).state("userEdit",{url:"bs_userEdit",templateUrl:"tpl/userEdit.html",controller:"userEditCtrl"});$urlRouterProvider.otherwise("/bs_start")});bs.controller("bsCtrl",["$scope","$state","$timeout","$location","$ionicTabsDelegate",function($scope,$state,$timeout,$location,$ionicTabsDelegate){$scope.userMsgManager=function(){$scope.uid=sessionStorage["uid"]||"";$scope.isLogin=Boolean($scope.uid);$scope.uname=sessionStorage["uname"]||"";$scope.myCart={badge:sessionStorage["cartBadge"]||""}};$scope.userMsgManager();$scope.configLoading=function(){$timeout(function(){var router=$location.$$url.split("#")[0].split("/")[1];if(router==="bs_start"){return}var currHeaderTitle="";$scope.isShowHeader=true;$scope.isShowFooterTabs=false;$scope.isShowLogo=false;$scope.isShowBack=true;switch(router){case"bs_main":currHeaderTitle="落星书屋";$scope.isShowHeader=false;$scope.isShowLogo=true;$scope.isShowBack=false;break;case"bs_myCart":currHeaderTitle="书车页";$scope.isShowFooterTabs=true;$scope.isShowBack=false;break;case"bs_detail":currHeaderTitle="书详情页";break;case"bs_order":currHeaderTitle="订单信息页";break;case"bs_user":currHeaderTitle="登录 / 注册";break;case"bs_userMsg":currHeaderTitle="我的信息";break;case"bs_userEdit":currHeaderTitle="个人信息编辑页";break;case"bs_myHeart":currHeaderTitle="我的收藏";break;case"bs_myOrder":currHeaderTitle="我的订单";break;default:break}$scope.headerTitle=currHeaderTitle},0)};$scope.configLoading();$scope.homeClass="ion-ios-home-outline";$scope.goHome=function(){if($location.$$url==="/bs_main"){return}$scope.homeClass="ion-ios-home";$timeout(function(){$scope.homeClass="ion-ios-home-outline";$scope.jump("main")},200)};$scope.goBack=function(){if(window){window.history.back();$timeout(function(){$scope.configLoading()},0)}};$scope.footerTabSelect=function(index,router){$ionicTabsDelegate.select(index);router&&$scope.jump(router)};$scope.jump=function(desState,params){$state.go(desState,params);$timeout(function(){$scope.configLoading()},0)};$scope.exitNowAccount=function(){sessionStorage.removeItem("uid");sessionStorage.removeItem("uname");sessionStorage.removeItem("cartBadge");$scope.userMsgManager();$scope.jump("user")}}]);bs.controller("mainCtrl",["$scope","$get","$ionicSideMenuDelegate","$ionicModal",function($scope,$get,$ionicSideMenuDelegate,$ionicModal){$scope.showSide=function(e){$ionicSideMenuDelegate.toggleLeft()};$scope.hasMore=true;$scope.info={kw:""};$scope.books=[];$scope.infoList=[{name:"开发者",value:"落星"},{name:"版本号",value:"version 1.0"},{name:"email",value:"luoxing8493@126.com"},{name:"开发者个人网站",value:"huangjianyi.applinzi.com"}];$ionicModal.fromTemplateUrl("tpl/about.html",{scope:$scope,animation:"slide-in-up"}).then(function(modal){$scope.aboutModal=modal});$scope.open=function(){$scope.aboutModal.show()};$scope.close=function(){$scope.aboutModal.hide()};$scope.exitApp=function(){ionic.Platform.exitApp()
};function getBooks(){$get.sendRequest("./data/bs_getByPage.php",function(response){var data=response.data;if(data.length){$scope.books=data;$scope.hasBooks=true;return}$scope.hasBooks=false})}getBooks();$scope.loadMore=function(){if($scope.books){$get.sendRequest("./data/bs_getByPage.php?start="+$scope.books.length,function(response){$scope.books=$scope.books.concat(response.data);$scope.$broadcast("scroll.infiniteScrollComplete");if(response.data.length<5){$scope.hasMore=false}})}};$scope.$watch("info.kw",function(){if($scope.info.kw){$get.sendRequest("./data/bs_getByKW.php?kw="+$scope.info.kw,function(response){var data=response.data;if(data.length){$scope.books=response.data;$scope.hasBooks=true;return}$scope.hasBooks=false});return}getBooks()})}]);bs.controller("detailCtrl",["$scope","$get","$post","$stateParams",function($scope,$get,$post,$stateParams){$scope.isHeart=false;var bookId=$stateParams.bid;$get.sendRequest("./data/bs_detail.php?bid="+bookId,function(response){$scope.book=response.data;if(!$scope.$parent.isLogin){return}$get.sendRequest("./data/heart_has.php?uid="+$scope.$parent.uid+"&bid="+bookId,function(response){$scope.isHeart=response.isHeart})});$scope.toggleHeart=function(){if(!$scope.$parent.isLogin){$scope.$parent.jump("user");return}$post.sendRequest("./data/heart_toggle.php",{uid:$scope.$parent.uid,bid:bookId},function(response){$scope.isHeart=response.isHeart})};$scope.goCart=function(){$scope.$parent.footerTabSelect(1,"myCart")};$scope.addToCart=function(){if(!$scope.$parent.isLogin){$scope.$parent.jump("user");return}$post.sendRequest("./data/cart_add.php",{uid:$scope.$parent.uid,bid:bookId},function(response){if(response.isExist){$scope.$parent.myCart.badge=++sessionStorage["cartBadge"]}})};$scope.goBuy=function(){var url="order";if(!$scope.$parent.isLogin){url="user"}$scope.$parent.jump(url,{bid:bookId})}}]);bs.controller("myCartCtrl",["$scope","$get","$post","$bsAlter","$ionicTabsDelegate","$ionicPopup",function($scope,$get,$post,$bsAlter,$ionicTabsDelegate,$ionicPopup){$scope.hasBook=false;$ionicTabsDelegate.selectedIndex()!==1&&$scope.footerTabSelect(1);if(!$scope.$parent.isLogin){return}$get.sendRequest("./data/cart_select.php?uid="+$scope.$parent.uid,function(response){if(response.data.length){$scope.hasBook=true}var selectCount=0;$scope.carts=response.data.map(function(record){record.cid=Number(record.cid);record.bid=Number(record.bid);record.bookCount=Number(record.bookCount);record.isSelect=Boolean(record.isSelect);if(record.isSelect){selectCount++}return record});$scope.isSelectAll=selectCount?selectCount===$scope.carts.length:false;$scope.sumAll=function(){var totalPrice=0;$scope.carts.forEach(function(record){if(record.isSelect){totalPrice+=record.price*record.bookCount}});return totalPrice.toFixed(2)||0};function updateIsSelectServer(cids,isSelect){$post.sendRequest("./data/cart_updateSelect.php",{uid:$scope.$parent.uid,cids:cids,isSelect:Number(isSelect)})}$scope.selectBook=function(book){book.isSelect?selectCount++:selectCount--;$scope.isSelectAll=$scope.carts.length===selectCount;updateIsSelectServer([Number(book.cid)],book.isSelect)};$scope.selectAllBook=function(){var cartIds=[],isSelectAll=Boolean($scope.isSelectAll);$scope.carts=$scope.carts.map(function(record){if(record.isSelect!==isSelectAll){record.isSelect=isSelectAll;cartIds.push(Number(record.cid))}return record});updateIsSelectServer(cartIds,isSelectAll)};function updateCountServer(book){$post.sendRequest("./data/cart_updateCount.php",{uid:$scope.$parent.uid,cid:book.cid,bookCount:Number(book.bookCount)},function(response){book.isSelect=true})}$scope.validateBookCount=function(book){var bookCount=book.bookCount;if(bookCount===""||bookCount!==bookCount||isNaN(bookCount)||bookCount.indexOf(".")!==-1||bookCount<1){$bsAlter.alert("请输入大于1的整数")}updateCountServer(book)};$scope.increment=function(book){book.bookCount++;updateCountServer(book)};$scope.decrement=function(book){if(book.bookCount<=1){return}book.bookCount--;updateCountServer(book)};$scope.changeBookCount=function(book){$scope.oldBook={count:book.bookCount};$ionicPopup.show({template:'<button class="button button-small" :disabled="oldBook.count===1" ng-class="oldBook.count===1 ? \'button-stable\' : \'button-dark\'" ng-click="oldBook.count= oldBook.count <=1 ? oldBook.count : oldBook.count-1">-</button>'+'<input type="number" ng-model="oldBook.count">'+'<button class="button button-small button-dark" ng-click="oldBook.count=oldBook.count+1;">+</button>',title:"修改购买数量",scope:$scope,buttons:[{text:"取消",type:"button-stable"},{text:"<b>确定</b>",type:"button-positive",onTap:function(e){if($scope.oldBook.count===book.bookCount){return}book.bookCount=$scope.oldBook.count;updateCountServer(book)}}]})};$scope.$parent.jumpToOrder=function(){var cids=[];$scope.carts.forEach(function(cart){cids.push(cart.cid)});$scope.$parent.jump("order",{cids:cids})}})}]);bs.controller("orderCtrl",["$scope","$get","$post","$stateParams","$bsAlter",function($scope,$get,$post,$stateParams,$bsAlter){$scope.order={uid:$scope.$parent.uid,uname:"",phone:"",addr:""};
var bid=$stateParams.bid,cids=$stateParams.cids,url="./data/order_addFromBookDetail.php";if(bid){$scope.order.bid=bid}else{if(cids){$scope.order.cids=cids;url="./data/order_addFromCart.php"}}$scope.submitOrder=function(){if($scope.order.uname&&$scope.order.phone&&$scope.order.addr){$post.sendRequest(url,$scope.order,function(response){$scope.oid=response.oid;$scope.requestResult="下单成功，订单编号为"+$scope.oid;if(cids){$get.sendRequest("./data/cart_getCount.php?uid="+$scope.$parent.uid,function(response){$scope.$parent.myCart.badge=sessionStorage["cartBadge"]=response["cartBadge"]||0})}});return}$bsAlter.alert("请填写 收书人、手机号码、收书地址 信息")}}]);bs.controller("myOrderCtrl",["$scope","$get",function($scope,$get){$scope.$parent.userMsgManager("书单页");$get.sendRequest("./data/order_getByUid.php?uid="+$scope.$parent.uid,function(response){$scope.orderList=response.data})}]);bs.controller("myHeartCtrl",["$scope","$get",function($scope,$get){$scope.$parent.userMsgManager("关注页");$get.sendRequest("./data/heart_select.php?uid="+$scope.$parent.uid,function(response){$scope.heart=response.data})}]);bs.controller("userCtrl",["$scope","$post","$bsAlter",function($scope,$post,$bsAlter){function userTest(unameVal,upwdVal){if(!unameVal||!upwdVal){$bsAlter.alert("用户名或密码不能为空!");return false}else{if(!/^[A-Za-z0-9\u4e00-\u9fa5]{1,10}$/.test(unameVal)){$bsAlter.alert("用户名长度必须为1~10位，只能输入英文 / 中文 / 数字");return false}else{if(upwdVal.length<8||upwdVal.length>16){$bsAlter.alert("密码长度必须为8 ~ 16位");return false}}}return true}$scope.loginTest=function(){if(!userTest($scope.unameVal,$scope.upwdVal)){return}$post.sendRequest("./data/user_login.php",{uname:$scope.unameVal.trim(),upwd:$scope.upwdVal},function(response){sessionStorage["uid"]=response["uid"];sessionStorage["uname"]=response["uname"];sessionStorage["cartBadge"]=response["cartBadge"];$scope.$parent.userMsgManager();$scope.$parent.jump("main")})};$scope.registerTest=function(){if(!userTest($scope.unameVal,$scope.upwdVal)){return}$post.sendRequest("./data/user_register.php",{uname:$scope.unameVal.trim(),upwd:$scope.upwdVal},function(response){$bsAlter.alert("注册成功，请登录")})}}]);bs.controller("userMsgCtrl",["$scope","$get",function($scope,$get){$get.sendRequest("./data/user_orderAndHeartBadge.php?uid="+$scope.$parent.uid,function(response){$scope.heartBadge=response.heartBadge;$scope.orderBadge=response.orderBadge})}]);bs.controller("userEditCtrl",["$scope","$post","$bsAlter","$ionicModal","$timeout",function($scope,$post,$bsAlter,$ionicModal,$timeout){$scope.uname={val:$scope.$parent.uname};$scope.alterUname=function(){var newUname=$scope.uname.val;if(!newUname){$bsAlter.alert("用户名不能为空!");return}else{if(!/^[A-z\d\u4e00-\u9fa5]{1,10}$/.test(newUname)){$bsAlter.alert("用户名只能为英文 / 中文 / 数字");return}else{if(newUname===$scope.$parent.uname){$bsAlter.alert("新用户名和旧用户名一致");return}}}$post.sendRequest("./data/user_updateUname.php",{uid:$scope.$parent.uid,uname:newUname.trim()},function(response){$scope.$parent.uname=newUname;$bsAlter.alert("修改成功")})};$ionicModal.fromTemplateUrl("tpl/userUpdatePwd.html",{scope:$scope}).then(function(modal){$scope.updateUpwd=modal});$scope.openUpdatePwd=function(){$scope.updateUpwd.show()};$scope.closeUpdatePwd=function(){$scope.updateUpwd.hide()};$scope.upwd={oldVal:"",newVal:""};$scope.alterPwd=function(){var oldUpwd=$scope.upwd.oldVal,newUpwd=$scope.upwd.newVal;if(!oldUpwd||!newUpwd){$bsAlter.alert("旧密码或新密码不能为空");return}else{if(newUpwd.length<8||newUpwd.length>16){$bsAlter.alert("新密码长度必须为8 ~ 16位");return}else{if(oldUpwd===newUpwd){$bsAlter.alert("旧密码和新密码相同，请输入与旧密码不同的新密码");return}}}$post.sendRequest("./data/user_updateUpwd.php",{uid:$scope.$parent.uid,oldUpwd:oldUpwd,newUpwd:newUpwd},function(response){$scope.closeUpdatePwd();$bsAlter.alert("修改成功，请登录");$scope.$parent.exitNowAccount()})}}]);